# Ghost Steps Implementation Guide

## Overview

Ghost steps are internal steps automatically created by the DSL to support advanced features like fanout processing and conditional logic. They are invisible to users but essential for implementing complex workflow patterns while maintaining pgflow's simple step-based architecture.

All ghost steps use the `gen_` prefix to clearly indicate they are **generated by the DSL** rather than user-defined.

## Core Principles

1. **Ghost steps are regular steps** - The SQL core treats them identically to user-defined steps
2. **Generated by DSL only** - Users cannot create ghost steps directly
3. **Collision prevention via DSL** - Reserved prefixes are blocked at the DSL level
4. **Unique slug identification** - Each ghost step gets its own unique slug within the flow

## Slug Format Rules

### Basic Format
- **Regular steps**: `step_name`
- **Branch steps**: `branch__step_name` (double underscore separator)
- **Nested branches**: `branch1__branch2__step_name`
- **Ghost steps**: `[branch__]gen_TYPE_step_name` (where TYPE is prep, cond, etc.)

### Parsing Rules
1. **Step slug is the last part** after splitting on `__`
2. **Branch parts** are all parts before the last one
3. **Ghost detection** via `gen_` prefix checking on the step slug (last part)
4. **Ghost type extraction** via pattern `gen_TYPE_*` where TYPE is the ghost step type

## Ghost Step Types

### Array Steps (`gen_array_`)
- **Purpose**: Transform inputs, will be used for fanout processing and to prepare inputs for branches
- **Handler**: Returns array of items for parallel processing
- **Dependency**: Gets all original dependencies of the target step
- **Usage**: Created automatically when using `.fanoutStep()`

### Condition Steps (`gen_cond_`)  
- **Purpose**: Evaluate skip conditions for conditional execution
- **Handler**: Returns boolean value (true = proceed, false = skip)
- **Dependency**: Gets all original dependencies of the target step
- **Usage**: Created automatically when using conditional step methods

## Slug Examples

### Basic Steps

- top level step `load_users`: `load_users`
- step `send_email` nested in branch `kyc`: `kyc__send_email`
- array step for branch `kyc`: `gen_array_kyc`
- TS condition for branch `kyc`: `gen_cond_kyc`
- array step for step `send_email` nested in branch `kyc`: `kyc__gen_array_send_email`
- TS condition for step `send_email` nested in branch `kyc`: `kyc__gen_cond_send_email`

- step `fetch_report` nested in branch `report` which is nested in branch `kyc`: `kyc__report__fetch_report`
- array step for branch `report` which is nested in branch `kyc`: `kyc__gen_array_report`
- TS condition for branch `report` which is nested in branch `kyc`: `kyc__gen_cond_report`
- array step for step `fetch_report` nested in branch `report` which is nested in branch `kyc`: `kyc__report__gen_array_fetch_report`
- TS condition for step `fetch_report` nested in branch `report` which is nested in branch `kyc`: `kyc__report__gen_cond_fetch_report`

## Collision Prevention

### Branch vs Step Conflicts (DSL Level)
DSL **must prevent** using the same slug for `.step()` and `.branch()` at the same level:

**"Same level" definition**: Within the same scope/container
- **Top-level scope**: Steps and branches defined directly on the flow
- **Branch scope**: Steps and branches defined within a specific branch


### Prohibited Slug Prefixes (DSL Level)
Users **cannot** create steps or branches with slugs starting with:
- `gen_` - Reserved for all DSL-generated ghost step types

### Reserved Words (DSL Level)
Users **cannot** create steps or branches with these exact slugs:
- `output` - Reserved for flow output handling
- `run` - Reserved for run context (already blocked in SQL layer)

### Complete DSL Validation Rules
1. **Same-scope conflicts**: Cannot use same slug for step and branch in same scope
2. **Generated prefix**: Cannot start with `gen_` (steps and branches)  
3. **Reserved words**: Cannot use `output` or `run` (steps and branches)


## SQL Core Implementation

Ghost steps are processed identically to regular steps by the SQL core - no special treatment required.

### Dependency Chain Example
For a fanout step `send_email` depending on `load_data`:

1. `load_data` (regular step, no dependencies)
2. `gen_array_send_email` (ghost step, depends on `load_data`)  
3. `send_email` (regular step, depends on `gen_array_send_email`)

Ghost steps are automatically excluded from final flow output because they always have dependents.

## Implementation Benefits

- **Zero SQL changes** - Reuses all existing step infrastructure
- **Future-proof** - `gen_` namespace prevents all collision scenarios  
- **Simple** - Ghost step logic contained entirely in DSL

## Future Extensions

Future ghost step types: `gen_retry_*`, `gen_skip_*`, `gen_delay_*`, `gen_batch_*`, etc. 

New types require only DSL changes - zero SQL modifications needed.

