#!/usr/bin/env bash
set -e

# Script to test pgflow CLI install functionality
# Uses a temp directory to avoid conflicts with other tests

cd "$(dirname "$0")/.."
CLI_DIR=$(pwd)
WORKSPACE_ROOT=$(cd "${CLI_DIR}/../.." && pwd)

echo "ğŸ§ª Testing pgflow install functionality"

# Create temp directory for testing
TEST_DIR=$(mktemp -d)
echo "ğŸ“ Created test directory: ${TEST_DIR}"

# Cleanup function
cleanup() {
  echo "ğŸ§¹ Cleaning up..."
  rm -rf "${TEST_DIR}"
}

# Register cleanup on exit
trap cleanup EXIT

# Initialize a fresh Supabase project in temp directory
echo "ğŸ—ï¸ Creating new Supabase project"
pnpm -C "${CLI_DIR}" exec supabase init --force --with-vscode-settings --with-intellij-settings --workdir "${TEST_DIR}"

# Install pgflow with our CLI
echo "ğŸ“¦ Installing pgflow with CLI"
(cd "${CLI_DIR}" && PATH="${WORKSPACE_ROOT}/node_modules/.bin:$PATH" node dist/index.js install --supabase-path "${TEST_DIR}/supabase" --yes)

# Verify installation succeeded
echo "âœ… Verifying pgflow installation"
"${CLI_DIR}/scripts/assert-pgflow-installed" "${TEST_DIR}/supabase"

# Show success message
echo "âœ¨ Installation test complete"
