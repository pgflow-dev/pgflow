#!/usr/bin/env bash
set -euo pipefail

# Script to test pgflow CLI install functionality
# This simulates the test:e2e:install target from project.json

cd "$(dirname "$0")/.."
ROOT_DIR=$(pwd)

# Create unique temp directory for this test
TEST_DIR=$(mktemp -d)
trap "rm -rf $TEST_DIR" EXIT

echo "ğŸ§ª Testing pgflow install functionality"
echo "ğŸ“ Test directory: $TEST_DIR"

# Initialize a fresh Supabase project in temp dir
cd "$TEST_DIR"
echo "ğŸ—ï¸ Creating new Supabase project"
pnpm --dir="$ROOT_DIR" supabase init --workdir "$TEST_DIR" --with-vscode-settings --with-intellij-settings

# Install pgflow with our CLI
echo "ğŸ“¦ Installing pgflow with CLI"
node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes

# Verify installation succeeded
echo "âœ… Verifying pgflow installation"
"$ROOT_DIR/scripts/assert-pgflow-installed"

# Show success message
echo "âœ¨ Installation test complete"

# Optional: Test for duplicates by running install again
if [ "$1" == "--test-duplicates" ]; then
  echo "ğŸ”„ Testing duplicate installation prevention"
  node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes
fi
