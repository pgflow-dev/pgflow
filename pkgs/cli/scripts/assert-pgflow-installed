#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Accept optional path argument, default to "supabase"
SUPABASE_PATH="${1:-supabase}"

# Function to print error and exit
error() {
  echo -e "${RED}ERROR: $1${NC}" >&2
  exit 1
}

# Verify migrations directory and SQL files
if [ ! -d "${SUPABASE_PATH}/migrations" ] || [ -z "$(ls -A ${SUPABASE_PATH}/migrations/*.sql 2>/dev/null)" ]; then
  error "No SQL migration files found in ${SUPABASE_PATH}/migrations/"
fi

# Verify per_worker policy in config.toml
if ! grep -q 'policy = "per_worker"' "${SUPABASE_PATH}/config.toml"; then
  error "policy = \"per_worker\" not found in ${SUPABASE_PATH}/config.toml"
fi

# Verify db.pooler is enabled
if ! grep -A1 'db.pooler' "${SUPABASE_PATH}/config.toml" | grep -q 'enabled = true'; then
  error "db.pooler enabled = true not found in ${SUPABASE_PATH}/config.toml"
fi

# All checks passed
echo -e "${GREEN}All verification checks passed successfully!${NC}"
exit 0
