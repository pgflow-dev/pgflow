#!/usr/bin/env bash
set -e

# Script to test pgflow CLI install duplicate prevention
# Uses a temp directory to avoid conflicts with other tests

cd "$(dirname "$0")/.."
CLI_DIR=$(pwd)
WORKSPACE_ROOT=$(cd "${CLI_DIR}/../.." && pwd)

echo "ğŸ§ª Testing pgflow migration duplicate prevention"

# Create temp directory for testing
TEST_DIR=$(mktemp -d)
echo "ğŸ“ Created test directory: ${TEST_DIR}"

# Cleanup function
cleanup() {
  echo "ğŸ§¹ Cleaning up..."
  rm -rf "${TEST_DIR}"
}

# Register cleanup on exit
trap cleanup EXIT

# Initialize a fresh Supabase project in temp directory
echo "ğŸ—ï¸ Creating new Supabase project"
pnpm -C "${CLI_DIR}" exec supabase init --force --with-vscode-settings --with-intellij-settings --workdir "${TEST_DIR}"

# First installation with pgflow CLI
echo "ğŸ“¦ First pgflow installation"
(cd "${CLI_DIR}" && PATH="${WORKSPACE_ROOT}/node_modules/.bin:$PATH" node dist/index.js install --supabase-path "${TEST_DIR}/supabase" --yes)

# Count number of migrations after first install
FIRST_COUNT=$(find "${TEST_DIR}/supabase/migrations" -name "*.sql" | wc -l)
echo "ğŸ”¢ Found $FIRST_COUNT migrations after first install"

# Second installation with pgflow CLI
echo "ğŸ”„ Running second pgflow installation"
(cd "${CLI_DIR}" && PATH="${WORKSPACE_ROOT}/node_modules/.bin:$PATH" node dist/index.js install --supabase-path "${TEST_DIR}/supabase" --yes)

# Count number of migrations after second install
SECOND_COUNT=$(find "${TEST_DIR}/supabase/migrations" -name "*.sql" | wc -l)
echo "ğŸ”¢ Found $SECOND_COUNT migrations after second install"

# Verify no duplicates were created
if [ "$FIRST_COUNT" -eq "$SECOND_COUNT" ]; then
  echo "âœ… Success: No duplicate migrations were created"
else
  echo "âŒ Error: Duplicate migrations detected ($SECOND_COUNT - $FIRST_COUNT = $((SECOND_COUNT - FIRST_COUNT)) new files)"
  exit 1
fi
