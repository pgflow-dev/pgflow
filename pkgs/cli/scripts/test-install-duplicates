#!/usr/bin/env bash
set -euo pipefail

# Script to test pgflow CLI install duplicate prevention
# This verifies that we don't create duplicate migrations

cd "$(dirname "$0")/.."
ROOT_DIR=$(pwd)

# Create unique temp directory for this test
TEST_DIR=$(mktemp -d)
trap "rm -rf $TEST_DIR" EXIT

echo "ğŸ§ª Testing pgflow migration duplicate prevention"
echo "ğŸ“ Test directory: $TEST_DIR"

# Initialize a fresh Supabase project in temp dir
cd "$TEST_DIR"
echo "ğŸ—ï¸ Creating new Supabase project"
pnpm --dir="$ROOT_DIR" supabase init --with-vscode-settings --with-intellij-settings

# First installation with pgflow CLI
echo "ğŸ“¦ First pgflow installation"
node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes

# Count number of migrations after first install
FIRST_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
echo "ğŸ”¢ Found $FIRST_COUNT migrations after first install"

# Second installation with pgflow CLI
echo "ğŸ”„ Running second pgflow installation"
node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes

# Count number of migrations after second install
SECOND_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
echo "ğŸ”¢ Found $SECOND_COUNT migrations after second install"

# Verify no duplicates were created
if [ "$FIRST_COUNT" -eq "$SECOND_COUNT" ]; then
  echo "âœ… Success: No duplicate migrations were created"
else
  echo "âŒ Error: Duplicate migrations detected ($SECOND_COUNT - $FIRST_COUNT = $((SECOND_COUNT - FIRST_COUNT)) new files)"
  exit 1
fi

# Optional: Run a third time with different timestamps
if [ "$1" == "--test-third-install" ]; then
  # Modify a migration file timestamp to simulate a user renaming it
  RANDOM_MIGRATION=$(find supabase/migrations -name "*.sql" | head -1)
  NEW_NAME=$(echo "$RANDOM_MIGRATION" | sed 's/[0-9]\{14\}_/99999999999999_/')
  
  echo "ğŸ”„ Renaming $RANDOM_MIGRATION to $NEW_NAME"
  mv "$RANDOM_MIGRATION" "$NEW_NAME"
  
  echo "ğŸ”„ Running third pgflow installation"
  node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes
  
  # Count number of migrations after third install
  THIRD_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
  echo "ğŸ”¢ Found $THIRD_COUNT migrations after third install"
  
  if [ "$SECOND_COUNT" -eq "$THIRD_COUNT" ]; then
    echo "âœ… Success: No duplicate migrations were created (even with timestamp changes)"
  else
    echo "âŒ Error: Duplicate migrations detected after timestamp changes"
    exit 1
  fi
fi