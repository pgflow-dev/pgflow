#!/usr/bin/env bash
set -e

# Script to test if pgflow CLI compile hangs on flows with async functions
# This reproduces issue #123: https://github.com/pgflow-dev/pgflow/issues/123
#
# Issue: Compilation hangs on flow with async functions
# Reporter: @cpursley
# Description: Running compile on a flow with async function handlers was hanging.
#              After commenting out the async keywords, compilation worked.

cd "$(dirname "$0")/.."
ROOT_DIR=$(pwd)

echo "üß™ Testing async function compilation"
echo "   Issue #123: https://github.com/pgflow-dev/pgflow/issues/123"
echo ""

# Clean up any existing output
echo "üßπ Cleaning up old test directory"
rm -rf supabase/

# Initialize a fresh Supabase project
echo "üèóÔ∏è Creating new Supabase project"
npx -y supabase@latest init --force --with-vscode-settings --with-intellij-settings

# Install pgflow with our CLI
echo "üì¶ Installing pgflow with CLI"
node dist/index.js install --supabase-path supabase/ --yes

# Try to compile the flow with async functions
echo "üîß Compiling flow with async functions"
timeout 30s node dist/index.js compile examples/async-function-hang.ts --deno-json examples/deno.json --supabase-path supabase || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo "‚ùå FAILURE: Compilation hung and was killed by timeout (30s)"
    echo "This confirms issue #123 - compilation hangs on flows with async functions"
    exit 1
  else
    echo "‚ùå FAILURE: Compilation failed with exit code $EXIT_CODE"
    exit $EXIT_CODE
  fi
}

# Verify compilation succeeded
echo "‚úÖ Verifying flow compilation"
if ! grep -q "create_flow.*upload_company_logo" supabase/migrations/*.sql; then
  echo "‚ùå FAILURE: No migration found with create_flow for 'upload_company_logo'"
  exit 1
fi

# Show success message
echo ""
echo "‚ú® Async function compilation test complete!"
echo "   Issue #123 appears to be fixed or not reproducible in this environment."
echo "   See: https://github.com/pgflow-dev/pgflow/issues/123"
