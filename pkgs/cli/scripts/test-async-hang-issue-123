#!/usr/bin/env bash
set -euo pipefail

# Script to test if pgflow CLI compile hangs on flows with async functions
# This reproduces issue #123: https://github.com/pgflow-dev/pgflow/issues/123
#
# Issue: Compilation hangs on flow with async functions
# Reporter: @cpursley
# Description: Running compile on a flow with async function handlers was hanging.
#              After commenting out the async keywords, compilation worked.

cd "$(dirname "$0")/.."
ROOT_DIR=$(pwd)

# Create unique temp directory for this test
TEST_DIR=$(mktemp -d)
trap "rm -rf $TEST_DIR" EXIT

echo "üß™ Testing async function compilation"
echo "   Issue #123: https://github.com/pgflow-dev/pgflow/issues/123"
echo "üìÅ Test directory: $TEST_DIR"
echo ""

# Initialize a fresh Supabase project in temp dir
cd "$TEST_DIR"
echo "üèóÔ∏è Creating new Supabase project"
pnpm --dir="$ROOT_DIR" supabase init --workdir "$TEST_DIR" --with-vscode-settings --with-intellij-settings

# Install pgflow with our CLI
echo "üì¶ Installing pgflow with CLI"
node "$ROOT_DIR/dist/index.js" install --supabase-path supabase/ --yes

# Try to compile the flow with async functions
echo "üîß Compiling flow with async functions"
timeout 30s node "$ROOT_DIR/dist/index.js" compile "$ROOT_DIR/examples/async-function-hang.ts" --deno-json "$ROOT_DIR/examples/deno.json" --supabase-path supabase || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo "‚ùå FAILURE: Compilation hung and was killed by timeout (30s)"
    echo "This confirms issue #123 - compilation hangs on flows with async functions"
    exit 1
  else
    echo "‚ùå FAILURE: Compilation failed with exit code $EXIT_CODE"
    exit $EXIT_CODE
  fi
}

# Verify compilation succeeded
echo "‚úÖ Verifying flow compilation"
if ! grep -q "create_flow.*upload_company_logo" supabase/migrations/*.sql; then
  echo "‚ùå FAILURE: No migration found with create_flow for 'upload_company_logo'"
  exit 1
fi

# Show success message
echo ""
echo "‚ú® Async function compilation test complete!"
echo "   Issue #123 appears to be fixed or not reproducible in this environment."
echo "   See: https://github.com/pgflow-dev/pgflow/issues/123"
