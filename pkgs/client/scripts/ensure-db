#!/bin/bash
set -e

echo "Ensuring test database is ready..."

# Check if supabase is running
if ! supabase status > /dev/null 2>&1; then
  echo "Starting Supabase..."
  supabase start
fi

# Reset database (migrations should already be prepared by supabase:prepare target)
echo "Resetting database..."
supabase db reset

# Wait for realtime system to stabilize after db reset
# This is a workaround for a known Supabase local dev bug where realtime
# doesn't work properly immediately after database reset
echo "Waiting for realtime system to stabilize..."
sleep 5

echo "Test database is ready!"