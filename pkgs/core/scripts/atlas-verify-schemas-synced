#!/bin/bash
set -e

# Create a temporary directory for migrations
TEMP_DIR=$(mktemp -d)
TEMP_MIGRATIONS_DIR="${TEMP_DIR}/migrations"

# Function to cleanup on exit
cleanup() {
  local exit_code=$?

  # Clean up temporary directory
  if [ -d "$TEMP_DIR" ]; then
    rm -rf "$TEMP_DIR"
  fi

  # Clean up any existing Atlas dev container
  docker rm -f atlas-dev-postgres-pgflow 2>/dev/null || true

  exit $exit_code
}

# Set trap to cleanup on exit
trap cleanup EXIT

# Clean up any existing Atlas dev container to avoid "schema already exists" errors
# Container name from docker "postgres" "pgflow" block
docker rm -f atlas-dev-postgres-pgflow 2>/dev/null || true

# Copy current migrations to temp directory
echo "Creating temporary migrations directory..."
cp -r supabase/migrations "$TEMP_MIGRATIONS_DIR"

# Baseline is pre-generated and committed (see atlas/dump-fresh-baseline.sh)
# No need to regenerate it here

# Use a simple fixed temporary name
temp_migration="temp_verify_schemas"

# Run atlas migrate diff using the temporary directory
echo "Running atlas migrate diff..."
output=$(atlas migrate diff \
  --config file://atlas/atlas.hcl \
  --env local \
  --dir "file://${TEMP_MIGRATIONS_DIR}" \
  "$temp_migration" 2>&1) || {
  echo "Atlas migrate diff command failed with error: $?"
  echo "$output"
  exit 1
}

# Print the output
echo "Atlas migrate diff output:"
echo "$output"

# Check if migration file was created in temp directory (indicates changes exist)
if ls "${TEMP_MIGRATIONS_DIR}"/*_"$temp_migration".sql 1> /dev/null 2>&1; then
  echo "Found temporary migration file, schemas are not synced"
  echo "Error: Schemas are not synced. Please update migrations or schemas."

  # Optionally show what the diff would be
  echo ""
  echo "Generated migration diff:"
  echo "------------------------"
  cat "${TEMP_MIGRATIONS_DIR}"/*_"$temp_migration".sql | head -50
  if [ $(wc -l < "${TEMP_MIGRATIONS_DIR}"/*_"$temp_migration".sql) -gt 50 ]; then
    echo "... (truncated)"
  fi
  echo "------------------------"

  exit 1
else
  # No migration created means schemas are synced
  echo "No temporary migration file found, schemas are synced"
  echo "Schemas are synced"
  exit 0
fi
