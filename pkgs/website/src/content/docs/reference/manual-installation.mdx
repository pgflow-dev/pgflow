---
title: Manual Installation
description: How to manually set up pgflow and Edge Worker without the installer
sidebar:
  order: 100
---

import { Aside, Steps } from "@astrojs/starlight/components";

This guide explains how to manually set up pgflow and Edge Worker without using the automatic installer. While we recommend using the `pgflow install` command for most users, this manual approach can be helpful in certain scenarios:

- When you need more control over the installation process
- When troubleshooting installation issues
- When integrating with custom deployment pipelines
- When you want to understand what happens behind the scenes

<Aside type="caution" title="Prerequisites">
- Supabase CLI version **2.50.3** or higher (check with `supabase -v`)
- A local Supabase project set up
- Basic understanding of Supabase configuration
</Aside>

## Manual Installation Steps

### 1. Install migration files

To manually install the required migration files:

**Download the latest release**

1. Go to the [pgflow GitHub releases page](https://github.com/pgflow-dev/pgflow/releases)
2. Download the source code zip file for the latest release
3. Extract the downloaded zip file
4. Create your migrations directory if it doesn't exist: `mkdir -p supabase/migrations`

**Copy the migration files**

Copy files from the extracted archive's `pkgs/core/supabase/migrations/*.sql` to your project's `supabase/migrations/` folder.

**Important:** Rename each migration file with a timestamp that comes after your latest existing migration. The format is `YYYYMMDDHHmmss_originalname.sql`. For example, if your latest migration is `20250101120000_create_users.sql`, rename the pgflow migrations to:
- `20250101120001_001_install_pgmq.sql`
- `20250101120002_002_create_pgflow_schema.sql`
- etc.

This ensures pgflow migrations run after your existing migrations in the correct order.

**Apply the migrations**

After copying the migration files, apply them:

```bash frame="none"
npx supabase migration up
```

:::note
The installation process is exactly the same whether you're using Edge Worker or pgflow, as pgflow builds on top of Edge Worker and the migration files include everything needed for both.
:::

### 2. Create environment file (optional)

For local development, no database configuration is needed - the worker auto-detects local Supabase and connects automatically.

If you want to configure log levels locally, create `supabase/functions/.env`:

```bash frame="none"
mkdir -p supabase/functions
```

```bash
# Log level (options: debug, info, warn, error)
EDGE_WORKER_LOG_LEVEL="info"
```

<Aside type="note" title="Production uses secrets, not .env">
The `.env` file is only for local development. For production on Supabase hosted, use `supabase secrets set` to configure `EDGE_WORKER_DB_URL`. See [Database Connection](/deploy/database-connection/) for details.
</Aside>

### 3. Setup Connection Pool

Modify the `db.pooler` section in your `supabase/config.toml` file
to enable pooler and make sure that `db.pool_mode` is set to `"transaction"`.

```diff lang="toml" {8}
  [db.pooler]
- enabled = false
+ enabled = true
  # Port to use for the local connection pooler.
  port = 54329
  # Specifies when a server connection can be reused by other clients.
  # Configure one of the supported pooler modes: `transaction`, `session`.
  pool_mode = "transaction"
  # How many server connections to allow per user/database pair.
  default_pool_size = 20
  # Maximum number of client connections allowed.
  max_client_conn = 100
```

:::note[Transaction Mode]
Edge Worker requires **transaction mode** connection because of Edge
Function early termination. This will change in the future.
:::

### 4. Setup Edge Runtime policy

Change the Edge Runtime policy to `per_worker` to enable
Background Tasks (see more in [Testing background tasks locally](https://supabase.com/docs/guides/functions/background-tasks#testing-background-tasks-locally)).

  ```diff lang="toml"
    [edge_runtime]
    enabled = true
    # Configure one of the supported request policies: `oneshot`, `per_worker`.
    # Use `oneshot` for hot reload, or `per_worker` for load testing.
  - policy = "oneshot"
  + policy = "per_worker"
    # Port to attach the Chrome inspector for debugging edge functions.
    inspector_port = 8083
  ```

### 5. Create flows directory

Create a `flows` directory in your `supabase` folder to store your flow definitions:

```bash frame="none"
mkdir -p supabase/flows
```

Create an example flow at `supabase/flows/greet-user.ts`:

```typescript title="supabase/flows/greet-user.ts"
import { Flow } from '@pgflow/dsl';

type Input = {
  firstName: string;
  lastName: string;
};

export const GreetUser = new Flow<Input>({
  slug: 'greetUser',
})
  .step(
    { slug: 'fullName' },
    (input) => `${input.run.firstName} ${input.run.lastName}`
  )
  .step(
    { slug: 'greeting', dependsOn: ['fullName'] },
    (input) => `Hello, ${input.fullName}!`
  );
```

Create `supabase/flows/index.ts` to export your flows:

```typescript title="supabase/flows/index.ts"
// Re-export all flows from this directory
// Example: export { MyFlow } from './my-flow.ts';

export { GreetUser } from './greet-user.ts';
```

### 6. Create Control Plane edge function

The Control Plane is an edge function that registers and serves your flows.

Create the directory:

```bash frame="none"
mkdir -p supabase/functions/pgflow
```

Create `supabase/functions/pgflow/index.ts`:

```typescript title="supabase/functions/pgflow/index.ts"
import { ControlPlane } from '@pgflow/edge-worker';
import * as flows from '../../flows/index.ts';

ControlPlane.serve(flows);
```

Create `supabase/functions/pgflow/deno.json` with the pgflow package imports (replace `VERSION` with your desired version):

```json title="supabase/functions/pgflow/deno.json"
{
  "imports": {
    "@pgflow/core": "npm:@pgflow/core@VERSION",
    "@pgflow/core/": "npm:@pgflow/core@VERSION/",
    "@pgflow/dsl": "npm:@pgflow/dsl@VERSION",
    "@pgflow/dsl/": "npm:@pgflow/dsl@VERSION/",
    "@pgflow/dsl/supabase": "npm:@pgflow/dsl@VERSION/supabase",
    "@pgflow/edge-worker": "jsr:@pgflow/edge-worker@VERSION",
    "@pgflow/edge-worker/": "jsr:@pgflow/edge-worker@VERSION/",
    "@pgflow/edge-worker/_internal": "jsr:@pgflow/edge-worker@VERSION/_internal"
  }
}
```

:::tip[Finding the latest version]
Check the [pgflow releases page](https://github.com/pgflow-dev/pgflow/releases) for the latest version number.
:::

### 7. Create example worker

The worker executes the tasks defined in your flows.

Create the directory:

```bash frame="none"
mkdir -p supabase/functions/greet-user-worker
```

Create `supabase/functions/greet-user-worker/index.ts`:

```typescript title="supabase/functions/greet-user-worker/index.ts"
import { EdgeWorker } from '@pgflow/edge-worker';
import { GreetUser } from '../../flows/greet-user.ts';

EdgeWorker.start(GreetUser);
```

Create `supabase/functions/greet-user-worker/deno.json` with the same imports (replace `VERSION` with your desired version):

```json title="supabase/functions/greet-user-worker/deno.json"
{
  "imports": {
    "@pgflow/core": "npm:@pgflow/core@VERSION",
    "@pgflow/core/": "npm:@pgflow/core@VERSION/",
    "@pgflow/dsl": "npm:@pgflow/dsl@VERSION",
    "@pgflow/dsl/": "npm:@pgflow/dsl@VERSION/",
    "@pgflow/dsl/supabase": "npm:@pgflow/dsl@VERSION/supabase",
    "@pgflow/edge-worker": "jsr:@pgflow/edge-worker@VERSION",
    "@pgflow/edge-worker/": "jsr:@pgflow/edge-worker@VERSION/",
    "@pgflow/edge-worker/_internal": "jsr:@pgflow/edge-worker@VERSION/_internal"
  }
}
```

### 8. Restart Supabase

To apply the changes, restart Supabase:

```bash frame="none"
npx supabase stop
npx supabase start
```

## What gets installed

When following these steps, the installation sets up:

**Database (via migrations):**
- `pgflow` schema with tables for flows, execution state, and worker management
- `pgmq` schema for message queuing
- SQL functions for worker lifecycle management and flow operations

**Configuration:**
- Connection pooler enabled with transaction mode
- Edge runtime policy set to `per_worker`
- Environment file for log level (database connection auto-detected locally)

**Edge Functions:**
- Control Plane (`supabase/functions/pgflow/`) - registers and serves your flows
- Example worker (`supabase/functions/greet-user-worker/`) - executes flow tasks

**Flow definitions:**
- Flows directory (`supabase/flows/`) with example GreetUser flow

## What's the difference?

The manual installation process performs the same steps as the automatic `pgflow install` command, but gives you direct control over each step. The automatic installer:

1. Detects your Supabase project directory (or uses the provided path)
2. Updates your `config.toml` file (pooler + edge runtime settings)
3. Copies the migration files with proper timestamps
4. Creates the flows directory with example flow
5. Creates the Control Plane edge function
6. Creates the example worker edge function
7. Creates the environment file with log level settings

The automatic installer also:
- Checks if each component is already installed to avoid duplicates
- Creates backups before modifying existing files
- Uses the current pgflow version for package imports
- Provides helpful feedback during installation

If you encounter any issues with the automatic installer, this manual approach can help you identify and fix specific problems in your setup.

## Verifying your installation

After completing the installation, verify it by running these queries:

```sql
-- Verify worker schema
SELECT * FROM pgflow.workers LIMIT 1;

-- Verify pgflow schema
SELECT * FROM pgflow.flows LIMIT 1;
```

If these queries run without errors (they may return no rows, which is expected for a fresh installation), your installation was successful and you can proceed to using the features.
