---
title: Worker Lifecycle
description: How pgflow workers poll, heartbeat, and auto-restart
sidebar:
  order: 30
---

import { Aside, CardGrid, LinkCard } from '@astrojs/starlight/components';

pgflow workers are designed to be resilient. They poll for tasks, send heartbeats, and automatically restart when they stop.

## The Lifecycle Loop

```d2
...@../../../assets/pgflow-theme.d2

direction: right

startup: "Worker\nstarts"
startup.class: step_started

polling: "Worker polls\nfor tasks"
polling.class: step_completed

heartbeat: "Sends heartbeat\nto DB (every 6s)"
heartbeat.class: step_completed

timeout: "Edge Function\ntime limit hit"
timeout.class: warning

shutdown: "Worker stops\n(stopped_at recorded)"
shutdown.class: warning

cron_check: "Cron detects\nmissing heartbeat"
cron_check.class: info

restart: "Cron sends\nHTTP request"
restart.class: info

startup -> polling: "begins\npolling"
polling -> heartbeat: "pings DB\nevery 6s"
heartbeat -> polling: "continues" {style.stroke-dash: 3}
polling -> timeout: "after\n150-400s"
timeout -> shutdown: "graceful\nshutdown"
shutdown -> cron_check: "worker\ngone"
cron_check -> restart: "needs\nrestart"
restart -> startup: "starts new\nworker"
```

1. **Startup** - Worker begins polling for tasks
2. **Heartbeats** - Every 6 seconds, worker pings the database
3. **Graceful shutdown** - `stopped_at` timestamp recorded when worker stops
4. **Auto-restart** - Cron detects missing heartbeat, starts new instance

## Why Workers Stop

Edge Functions have execution time limits:

- Free tier: 150 seconds
- Paid tier: 400 seconds

When a worker hits this limit, it stops. The cron detects missing heartbeats and starts a new instance automatically.

## Code Changes (Local Development)

```d2
...@../../../assets/pgflow-theme.d2

direction: right

code_change: "You edit\nflow code"
code_change.class: neutral

fn_restart: "Edge Runtime\nkills & restarts"
fn_restart.class: step_started

cron_trigger: "Cron sends\nHTTP request"
cron_trigger.class: info

auto_compile: "Worker compiles\nnew flow & polls"
auto_compile.class: step_completed

code_change -> fn_restart: "file watch\ndetects change"
fn_restart -> cron_trigger: "cron runs\nevery 1s"
cron_trigger -> auto_compile: "starts\nworker"
auto_compile -> code_change: "ready for\nnext change" {style.stroke-dash: 3}
```

When you modify your flow code locally, everything restarts automatically (see [Startup Compilation](/concepts/startup-compilation/) for the detailed decision tree):

1. **Edge runtime detects change** - Supabase Edge Runtime watches for file changes
2. **Function restarts** - The modified function is reloaded
3. **Cron triggers function** - pgflow cron sends HTTP request to the function
4. **Worker starts** - Worker compares flow shape with database
5. **Auto-recompile if needed** - If shape changed, deletes old flow + data, compiles new one

You don't need to manually curl or restart anything after the initial setup.

## Local vs Production Behavior

| Aspect              | Local                        | Production                            |
| ------------------- | ---------------------------- | ------------------------------------- |
| Cron interval       | 1 second                     | 1 second                              |
| HTTP request        | Always for enabled functions | Only if not enough active workers     |
| Debounce            | Bypassed                     | Applied (prevents too frequent pings) |
| Active worker check | Bypassed                     | Required (enabled, non-deprecated)    |
| Detection           | Automatic (is_local)         | Automatic                             |

## Related

<CardGrid>
  <LinkCard
    title="Worker Management"
    href="/deploy/worker-management/"
    description="How to register, deprecate, and track workers"
  />
  <LinkCard
    title="Startup Compilation"
    href="/concepts/startup-compilation/"
    description="How flows are compiled when workers start"
  />
  <LinkCard
    title="Local Development"
    href="/build/local-development/"
    description="Tips for local development"
  />
  <LinkCard
    title="Troubleshooting Stalled Tasks"
    href="/deploy/troubleshooting-stalled-tasks/"
    description="Recover tasks left behind when workers terminate unexpectedly"
  />
</CardGrid>
