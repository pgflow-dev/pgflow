---
title: Understanding Flows
description: Learn how the scaffolded GreetUser flow works
sidebar:
  order: 20
---

import { Aside, CardGrid, LinkCard } from "@astrojs/starlight/components";
import { FileTree } from '@astrojs/starlight/components';

The `pgflow install` command created an example flow that demonstrates core pgflow concepts. Let's understand how it works.

<Aside type="tip">
If you haven't run the example yet, start with the [Quickstart](/get-started/flows/quickstart/).
</Aside>

## Project structure

<FileTree>
- supabase
  - flows
    - greet-user.ts (flow definition)
    - index.ts (re-exports all flows)
  - functions
    - pgflow
      - index.ts (Control Plane)
    - greet-user-worker
      - index.ts (Edge Worker)
</FileTree>

## The GreetUser flow

Open `supabase/flows/greet-user.ts`:

```typescript title="supabase/flows/greet-user.ts"
import { Flow } from '@pgflow/dsl';

type Input = {
  firstName: string;
  lastName: string;
};

export const GreetUser = new Flow<Input>({
  slug: 'greetUser',
})
  .step(
    { slug: 'fullName' },
    (input) => `${input.run.firstName} ${input.run.lastName}`
  )
  .step(
    { slug: 'greeting', dependsOn: ['fullName'] },
    (input) => `Hello, ${input.fullName}!`
  );
```

Let's break down each part:

### Input type

```typescript
type Input = {
  firstName: string;
  lastName: string;
};
```

This defines what data the flow accepts when started. The input is always accessible via `input.run` in any step.

### Flow constructor

```typescript
export const GreetUser = new Flow<Input>({
  slug: 'greetUser',
})
```

- **Named export**: Flows use named exports (not default), making them easy to import elsewhere
- **Generic type**: `Flow<Input>` provides type safety for the input
- **Slug**: A unique identifier used in the database and when starting flows

### First step: fullName

```typescript
.step(
  { slug: 'fullName' },
  (input) => `${input.run.firstName} ${input.run.lastName}`
)
```

- **No dependencies**: This step runs immediately when the flow starts
- **`input.run`**: Contains the original flow input
- **Return value**: The string becomes available to dependent steps

### Second step: greeting

```typescript
.step(
  { slug: 'greeting', dependsOn: ['fullName'] },
  (input) => `Hello, ${input.fullName}!`
)
```

- **`dependsOn`**: This step waits for `fullName` to complete
- **`input.fullName`**: Access the result from the `fullName` step by its slug
- **Final output**: When the last step completes, its result becomes the flow output

## Flow registration

The `supabase/flows/index.ts` file re-exports all flows:

```typescript title="supabase/flows/index.ts"
export { GreetUser } from './greet-user.ts';
```

The Control Plane automatically imports all exports from this file:

```typescript title="supabase/functions/pgflow/index.ts"
import { ControlPlane } from '@pgflow/edge-worker';
import * as flows from '../../flows/index.ts';

ControlPlane.serve(flows);
```

## Try modifying the flow

1. Add a third step that uses the greeting:

   ```typescript
   .step(
     { slug: 'shout', dependsOn: ['greeting'] },
     (input) => input.greeting.toUpperCase()
   )
   ```

2. Save the file - Edge runtime automatically restarts the function
3. pgflow cron triggers the worker, which detects the new shape and recompiles
4. Trigger a new run to test your changes

<Aside type="caution">
Recompiling **deletes the existing flow and all its run data**. See [Startup Compilation](/concepts/startup-compilation/) for details.
</Aside>

:::note[Key Concepts]
- **input.run**: Contains the original flow input, accessible in every step
- **step slugs**: Unique identifiers for each step
- **dependsOn**: Specifies which steps must complete before a step can run
- **JSON serialization**: All inputs and outputs must be JSON-serializable

<CardGrid>
  <LinkCard
    title="How pgflow works"
    href="/concepts/how-pgflow-works/"
    description="Learn how pgflow executes workflows behind the scenes"
  />
  <LinkCard
    title="Understanding flows"
    href="/concepts/understanding-flows/"
    description="Learn how flows work, from syntax to execution"
  />
</CardGrid>
:::
