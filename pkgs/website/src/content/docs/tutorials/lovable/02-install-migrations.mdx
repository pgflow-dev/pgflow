---
title: "Step 2: Run Migrations"
description: Apply pgflow database migrations and configure vault secrets using a temporary installer
sidebar:
  order: 20
---

import { Aside, Steps } from '@astrojs/starlight/components';

This step creates a temporary Edge Function that securely runs pgflow migrations and configures vault secrets. The installer uses your project's service role key internally - it's never exposed to your frontend.

<Aside type="caution" title="Security note">
  The temporary installer function is created without JWT verification so you can invoke it directly.
  This is safe because:
  - It only calls the pgflow Control Plane (which requires service role authentication internally)
  - It's deleted immediately after use
  - It uses a fixed name, but future versions may use random names for added security
</Aside>

## How it works

<Steps>
1. You paste a prompt that creates a temporary installer Edge Function
2. Lovable shows you a link to invoke the function
3. You click the link - the installer runs migrations and configures secrets
4. You copy the JSON result and paste it back to Lovable
5. Lovable confirms success and deletes the temporary installer
</Steps>

## Installation prompt

Copy and paste this entire prompt into Lovable:

````text
I need to run pgflow database migrations. This requires a temporary installer Edge Function.

**STEP 1: Create the installer**

Create Edge Function `supabase/functions/pgflow-installer/index.ts` with this exact content:

```ts
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!;
const SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;

interface StepResult {
  success: boolean;
  status: number;
  data?: unknown;
  error?: string;
}

interface InstallerResult {
  success: boolean;
  secrets: StepResult;
  migrations: StepResult;
  message: string;
}

async function callControlPlane(
  endpoint: string,
  method: 'GET' | 'POST'
): Promise<StepResult> {
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/pgflow${endpoint}`, {
      method,
      headers: {
        'Authorization': `Bearer ${SERVICE_ROLE_KEY}`,
        'Content-Type': 'application/json',
      },
    });

    const data = await response.json();
    return {
      success: response.ok,
      status: response.status,
      data,
    };
  } catch (error) {
    return {
      success: false,
      status: 0,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

Deno.serve(async (_req: Request) => {
  console.log('pgflow installer starting...');

  // Step 1: Configure vault secrets
  console.log('Configuring vault secrets...');
  const secrets = await callControlPlane('/secrets/configure', 'POST');

  if (!secrets.success) {
    const result: InstallerResult = {
      success: false,
      secrets,
      migrations: { success: false, status: 0, error: 'Skipped - secrets failed' },
      message: 'Failed to configure vault secrets. Check the pgflow Control Plane is deployed.',
    };
    return new Response(JSON.stringify(result, null, 2), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }

  // Step 2: Run migrations
  console.log('Running migrations...');
  const migrations = await callControlPlane('/migrations/up', 'POST');

  const result: InstallerResult = {
    success: secrets.success && migrations.success,
    secrets,
    migrations,
    message: migrations.success
      ? 'pgflow installed successfully! Vault secrets configured and migrations applied.'
      : 'Secrets configured but migrations failed. Check the error details.',
  };

  console.log('Installer complete:', result.message);

  return new Response(JSON.stringify(result, null, 2), {
    status: result.success ? 200 : 500,
    headers: { 'Content-Type': 'application/json' },
  });
});
```

**STEP 2: Configure to skip JWT verification**

Add to `supabase/config.toml`:

```toml
[functions.pgflow-installer]
verify_jwt = false
```

**STEP 3: After the function is deployed, show me a link to invoke it**

The link format is: `https://[PROJECT_REF].supabase.co/functions/v1/pgflow-installer`

Present this as a clickable link so I can invoke the installer.

**STEP 4: Wait for me to paste the result**

After I click the link, I will copy the JSON response and paste it here.

The response will look like this if successful:
```json
{
  "success": true,
  "secrets": { "success": true, "status": 200, "data": {...} },
  "migrations": { "success": true, "status": 200, "data": {...} },
  "message": "pgflow installed successfully! Vault secrets configured and migrations applied."
}
```

Or like this if there's an error:
```json
{
  "success": false,
  "secrets": { "success": false, "status": 500, "error": "..." },
  "migrations": {...},
  "message": "Failed to configure vault secrets..."
}
```

**STEP 5: Interpret the result**

When I paste the JSON result:
- If `"success": true` - confirm that pgflow is installed and ready to use
- If `"success": false` - explain what went wrong based on the error messages

**STEP 6: Clean up**

After confirming success (or discussing the error), delete the temporary installer:
- Remove `supabase/functions/pgflow-installer/` folder
- Remove the `[functions.pgflow-installer]` section from `config.toml`

This keeps the project clean and removes the unauthenticated endpoint.
````

## What to expect

After pasting the prompt:

<Steps>
1. **Lovable creates the installer** - You'll see the function code being added
2. **Lovable shows you a link** - Click it to run the installer
3. **Copy the JSON result** - Select all the JSON output from the browser
4. **Paste it back to Lovable** - Lovable interprets whether it succeeded
5. **Lovable cleans up** - The temporary function is deleted
</Steps>

<Aside type="note" title="What does the installer do?">
  The installer performs two operations:

  1. **Configure vault secrets** - Stores `supabase_project_id` and `supabase_service_role_key` in Supabase Vault so pgflow workers can authenticate when calling Edge Functions

  2. **Run migrations** - Applies all pending pgflow migrations to create the required database schema (tables, functions, triggers)
</Aside>

## Troubleshooting

### "Failed to configure vault secrets"

This usually means the pgflow Control Plane function isn't deployed yet. Make sure you completed [Step 1: Install Control Plane](/tutorials/lovable/01-install-pgflow/) first.

### "Migrations failed"

Check the `migrations.data` field in the response for specific error messages. Common issues:
- Missing database permissions
- Conflicting table names
- Network timeout (try again)

### The link doesn't work

Ensure the function was deployed to Supabase. You may need to ask Lovable to deploy the Edge Functions to your connected Supabase project.

## Next steps

Congratulations! pgflow is now installed in your Lovable project. You can now:

- **Create workflows** - Ask Lovable to create flow definitions in `supabase/flows/`
- **Define tasks** - Build task functions that call AI APIs, process data, etc.
- **Run flows** - Start workflow executions from your app

Check out the [AI Web Scraper tutorial](/tutorials/ai-web-scraper/) for an example of building a complete workflow.
