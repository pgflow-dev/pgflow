prepare-commit-msg:
  scripts:
    "generate-commit-msg.sh":
      runner: bash

commit-msg:
  commands:
    "lint commit message":
      skip: true
      run: pnpm commitlint --edit {1}

post-commit:
  commands:
    "push changes to origin":
      skip:
        - ref: main
      run: git push

pre-commit:
  commands:
    # This task is skipped by default, un-skip it to debug the inputs
    debug:
      skip: true
      run: |
        echo staged_files="{staged_files}"
        exit 1

    frontend/prettier-fix:
      root: "pkgs/frontend"
      glob: "*.{svelte,js,ts,html,css,json}"
      run: |
        prettier --write {staged_files}
      stage_fixed: true

    frontend/check:
      root: "pkgs/frontend"
      glob: "*.{svelte,js,ts,html,css,json}"
      run: |
        turbo run check --scope=frontend

    frontend/lint:
      root: "pkgs/frontend"
      glob: "*.{svelte,js,ts,html,css,json}"
      run: |
        turbo run lint --scope=frontend

    # TODO: fix glob pattern for pdm.lock
    #       the problem is that globs without asterist or other special chars
    #       does not not work, so literal 'pdm.lock' is not picked up
    #       the workaround is to prepend the literal filename with '*'
    edulaw-ai-backend/check:
      root: "pkgs/edulaw-ai-backend"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        python_staged_files=$(echo "{staged_files}" | tr ' ' '\n' | grep '\.py$')
        pnpm check $python_staged_files

    edulaw-ai-backend/test:
      root: "pkgs/edulaw-ai-backend/"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        turbo run test --scope=edulaw-ai-backend

    edulaw-ai-backend/isort:
      root: "pkgs/edulaw-ai-backend/"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        pdm run isort {staged_files}
      stage_fixed: true

    edulaw-ai-backend/docker-build:
      root: "pkgs/edulaw-ai-backend/"
      glob: "{*Dockerfile,*compose.yaml}"
      run: |
        docker compose build

    supabase/check:
      root: "pkgs/supabase/functions/"
      glob: "*.ts"
      run: |
        turbo run check --scope=backend

    supabase/test:
      root: "pkgs/supabase/"
      glob: "**/*.sql"
      run: |
        turbo run test --scope=backend

    supabase/gen-types:
      root: "pkgs/supabase/"
      glob: "*.sql"
      run: |
        pnpm gen-types && git add types.d.ts

    # TODO: fix glob pattern for pdm.lock
    #       the problem is that globs without asterist or other special chars
    #       does not not work, so literal 'pdm.lock' is not picked up
    #       the workaround is to prepend the literal filename with '*'
    feed-processor/check:
      root: "pkgs/feed-processor"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        python_staged_files=$(echo "{staged_files}" | tr ' ' '\n' | grep '\.py$')
        pnpm check $python_staged_files

    feed-processor/test:
      root: "pkgs/feed-processor/"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        turbo run test --scope=feed-processor

    feed-processor/isort:
      root: "pkgs/feed-processor/"
      glob: "{*pyproject.toml,*pdm.lock,*.py}"
      run: |
        pdm run isort {staged_files}
      stage_fixed: true
