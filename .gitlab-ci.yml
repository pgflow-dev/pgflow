stages:
  - deploy

default:
  image: python:3.11-slim

.rule/main-branch-only:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.dependency/flyctl:
  before_script:
    - apt-get update -qq && apt-get install -y curl
    - curl -L https://fly.io/install.sh | sh
    - export FLYCTL_INSTALL="/root/.fly"
    - export PATH="$FLYCTL_INSTALL/bin:$PATH"

.pkg-changed/edulaw-ai-backend:
  rules:
    - changes:
        - pkgs/edulaw-ai-backend/**/*

deploy-prod/edulaw-ai-backend:
  before_script:
    - echo ci_commit_branch is $CI_COMMIT_BRANCH
    - echo ci_default_branch is $CI_DEFAULT_BRANCH
  extends:
    - .rule/main-branch-only
    - .pkg-changed/edulaw-ai-backend
    - .dependency/flyctl
  stage: deploy
  script:
    - cd pkgs/edulaw-ai-backend
    - flyctl deploy
  environment: production
