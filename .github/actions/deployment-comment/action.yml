name: 'Deployment Comment'
description: 'Post deployment status comments on PRs for both preview and production deployments'

inputs:
  project-name:
    description: 'Name of the project being deployed (e.g., website)'
    required: true
  preview-url:
    description: 'The preview deployment URL'
    required: false
  production-url:
    description: 'The production deployment URL'
    required: true
  deployment-status:
    description: 'Status of the deployment (success or failure)'
    required: true
    default: ${{ job.status }}

runs:
  using: 'composite'
  steps:
    # Preview deployment comment (for PRs)
    - name: Comment preview deployment on PR
      if: always() && github.event_name == 'pull_request'
      uses: mshick/add-pr-comment@v2
      with:
        message-id: preview-deployment-${{ inputs.project-name }}
        refresh-message-position: true
        message-success: |
          ## ğŸ” Preview Deployment: ${{ inputs.project-name }}
          
          âœ… **Deployment successful!**
          
          ğŸ”— **Preview URL**: ${{ inputs.preview-url }}
          
          ğŸ“ **Details**:
          - Branch: `${{ github.head_ref }}`
          - Commit: `${{ github.sha }}`
          - [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          _Last updated: ${{ github.event.head_commit.timestamp }}_
        message-failure: |
          ## ğŸ” Preview Deployment: ${{ inputs.project-name }}
          
          âŒ **Deployment failed!**
          
          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

    # Production deployment comment (for main branch)
    - name: Find PR for commit
      id: find-pr
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      shell: bash
      run: |
        PR_NUMBER=$(gh pr list --state merged --json number,mergeCommit --jq ".[] | select(.mergeCommit.oid == \"${{ github.sha }}\") | .number" | head -n1)
        echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Comment on merged PR
      if: always() && steps.find-pr.outputs.pr_number != '' && github.ref == 'refs/heads/main'
      uses: mshick/add-pr-comment@v2
      with:
        issue: ${{ steps.find-pr.outputs.pr_number }}
        message-id: production-deployment-${{ inputs.project-name }}
        refresh-message-position: true
        message-success: |
          ## ğŸš€ Production Deployment: ${{ inputs.project-name }}
          
          âœ… **Successfully deployed to production!**
          
          ğŸ”— **Production URL**: ${{ inputs.production-url }}
          
          ğŸ“ **Details**:
          - Commit: `${{ github.sha }}`
          - [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          _Deployed at: ${{ github.event.head_commit.timestamp }}_
        message-failure: |
          ## ğŸš€ Production Deployment: ${{ inputs.project-name }}
          
          âŒ **Production deployment failed!**
          
          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.