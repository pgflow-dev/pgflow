name: CI
on:
  pull_request:
    branches: ['**', '!changeset-release/**']
  push:
    branches: [main]
  # TODO: Optimize - separate deployment workflow to avoid re-running tests on main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  pull-requests: write # for preview comments
  deployments: write # Netlify action needs it

jobs:
# ─────────────────────────────────────── 1. DB VERIFICATION ──────────────────────────────────────
  db-verification:
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Run database verification
        run: pnpm nx run core:db:verify


# ─────────────────────────────────────── 2. FAST TESTS ──────────────────────────────────────
  fast-tests:
    needs: [db-verification]
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Lint, typecheck, build, and fast tests
        run: pnpm nx affected -t lint typecheck test --parallel --configuration=production --base="$NX_BASE" --head="$NX_HEAD"

      - name: Build all affected projects
        run: pnpm nx affected -t build --configuration=production --parallel --base="$NX_BASE" --head="$NX_HEAD"

      - name: Verify exports for built packages
        run: pnpm nx affected -t verify-exports --base="$NX_BASE" --head="$NX_HEAD"

# ─────────────────────────────────────── 3. CLI LIVE TESTS ──────────────────────────────────────
  cli-live-tests:
    needs: [db-verification]
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Check if cli is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^cli$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "CLI is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "CLI is not affected by changes - skipping"
          fi

      - name: Run cli live tests
        if: steps.check-affected.outputs.affected == 'true'
        run: pnpm nx run cli:test:live



# ─────────────────────────────────────── 4. CORE LIVE TESTS ──────────────────────────────────────
  core-live-tests:
    needs: [db-verification]
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Check if core is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^core$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Core is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Core is not affected by changes - skipping"
          fi

      - name: Run core live tests
        if: steps.check-affected.outputs.affected == 'true'
        run: pnpm nx run core:test:live


# ─────────────────────────────────────── 5. CLIENT LIVE TESTS ──────────────────────────────────────
  client-live-tests:
    needs: [db-verification]
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Check if client is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^client$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Client is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Client is not affected by changes - skipping"
          fi

      - name: Run client live tests
        if: steps.check-affected.outputs.affected == 'true'
        run: pnpm nx run client:test:live


# ─────────────────────────────────────── 6. EDGE-WORKER LIVE TESTS ──────────────────────────────────────
  edge-worker-live-tests:
    needs: [db-verification]
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup
        with:
          atlas-cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Check if edge-worker is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^edge-worker$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Edge-worker is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Edge-worker is not affected by changes - skipping"
          fi

      - name: Run edge-worker live tests
        if: steps.check-affected.outputs.affected == 'true'
        run: pnpm nx run edge-worker:test:live


# ────────────────────────────────── 7. DEPLOY PLAYGROUND ───────────────────────────
  deploy-playground:
    needs: [fast-tests]
    if: false  # Disabled
    # if: >-
    #   ${{
    #     (github.event_name == 'pull_request') ||
    #     (github.ref == 'refs/heads/main' && github.event_name == 'push')
    #   }}
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ github.event_name == 'pull_request' && secrets.DEMO_PREVIEW_SUPABASE_URL || secrets.DEMO_PRODUCTION_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ github.event_name == 'pull_request' && secrets.DEMO_PREVIEW_SUPABASE_ANON_KEY || secrets.DEMO_PRODUCTION_SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      # Build the workspace libraries that the app imports
      - run: pnpm nx run-many -t build --projects client,dsl --configuration=production

      - name: Build & deploy to Netlify
        id: deploy
        run: |
          pnpm netlify deploy --build --filter=playground \
            --context ${{ github.event_name == 'pull_request' && 'deploy-preview' || 'production' }} \
            ${{ github.event_name == 'pull_request' && format('--alias=pr-{0}', github.event.pull_request.number) || '--prod' }}

      - name: Post deployment comment
        if: always()
        uses: ./.github/actions/deployment-comment
        with:
          project-name: Playground
          preview-url: https://pr-${{ github.event.pull_request.number }}--pgflow-demo.netlify.app
          production-url: https://playground.pgflow.dev


# ────────────────────────────────── 8. DEPLOY WEBSITE ───────────────────────────
  deploy-website:
    needs: [fast-tests, cli-live-tests, core-live-tests, client-live-tests, edge-worker-live-tests]
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      DEPLOYMENT_ENV: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
      VITE_SUPABASE_URL: ${{ github.event_name == 'pull_request' && secrets.WEBSITE_PREVIEW_SUPABASE_URL || secrets.WEBSITE_PRODUCTION_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ github.event_name == 'pull_request' && secrets.WEBSITE_PREVIEW_SUPABASE_ANON_KEY || secrets.WEBSITE_PRODUCTION_SUPABASE_ANON_KEY }}
      PLAUSIBLE_PROXY_URL: ${{ secrets.WEBSITE_PLAUSIBLE_PROXY_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Set Nx base for affected commands
        run: |
          echo "NX_BASE=origin/main" >> $GITHUB_ENV
          echo "NX_HEAD=HEAD" >> $GITHUB_ENV

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Check if website is affected
        id: check-affected
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Always deploy website on main branch
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Main branch push - deploying website to production"
          elif pnpm nx show projects --affected -t build --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^website$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Website is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Website is not affected by changes - skipping deployment"
          fi

      - name: Deploy website
        id: deploy-website
        if: steps.check-affected.outputs.affected == 'true'
        env:
          CLOUDFLARE_BRANCH: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'main' }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            pnpm nx run website:deploy:preview --skip-nx-cache
          else
            pnpm nx run website:deploy --skip-nx-cache
          fi

      - name: Post deployment comment
        if: always()
        uses: ./.github/actions/deployment-comment
        with:
          project-name: Website
          preview-url: https://pr-${{ github.event.pull_request.number }}.pgflow.pages.dev
          production-url: https://pgflow.dev
