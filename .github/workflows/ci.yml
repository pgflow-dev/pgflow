name: CI
on:
  pull_request:
    branches: ['**', '!changeset-release/**']
  push:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  pull-requests: write       # for preview comments
  deployments: write         # Netlify action needs it

jobs:
# ─────────────────────────────────────── 1. BUILD & TEST ──────────────────────────────────────
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: '1.45.2'

      - name: Install sqruff
        uses: quarylabs/install-sqruff-cli-action@main

      - name: Setup Atlas
        uses: ariga/setup-atlas@master
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx SHAs for affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Quality gate (lint + typecheck + test)
        run: pnpm nx affected -t lint typecheck test --parallel --configuration=production --base="$NX_BASE" --head="$NX_HEAD"

      - name: Build all affected projects
        run: pnpm nx affected -t build --configuration=production --parallel --base="$NX_BASE" --head="$NX_HEAD"

      - name: Verify exports for built packages
        run: pnpm nx affected -t verify-exports --base="$NX_BASE" --head="$NX_HEAD"


# ─────────────────────────────────────── 2. EDGE-WORKER E2E ──────────────────────────────────────
  edge-worker-e2e:
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: '1.45.2'

      - name: Install sqruff
        uses: quarylabs/install-sqruff-cli-action@main

      - name: Setup Atlas
        uses: ariga/setup-atlas@master
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Set Nx SHAs for affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Check if edge-worker e2e tests are affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected -t test:e2e --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^edge-worker$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Edge-worker e2e tests are affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Edge-worker e2e tests are not affected by changes - skipping"
          fi

      - name: Run edge-worker e2e tests
        if: steps.check-affected.outputs.affected == 'true'
        run: pnpm nx affected -t test:e2e --parallel --base="$NX_BASE" --head="$NX_HEAD"


# ────────────────────────────────── 3. DEPLOY WEBSITE ───────────────────────────
  deploy-website:
    needs: [build-and-test, edge-worker-e2e]
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      DEPLOYMENT_ENV: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
      VITE_SUPABASE_URL: ${{ github.event_name == 'pull_request' && secrets.WEBSITE_PREVIEW_SUPABASE_URL || secrets.WEBSITE_PRODUCTION_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ github.event_name == 'pull_request' && secrets.WEBSITE_PREVIEW_SUPABASE_ANON_KEY || secrets.WEBSITE_PRODUCTION_SUPABASE_ANON_KEY }}
      PLAUSIBLE_PROXY_URL: ${{ secrets.WEBSITE_PLAUSIBLE_PROXY_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Set Nx SHAs for affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Check if website is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected -t build --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^website$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Website is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Website is not affected by changes - skipping deployment"
          fi

      - name: Validate Supabase environment variables
        if: steps.check-affected.outputs.affected == 'true'
        run: |
          if [ -z "$VITE_SUPABASE_URL" ]; then
            echo "❌ Error: VITE_SUPABASE_URL is not set"
            echo "Required GitHub secret missing: WEBSITE_${{ github.event_name == 'pull_request' && 'PREVIEW' || 'PRODUCTION' }}_SUPABASE_URL"
            exit 1
          fi
          if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "❌ Error: VITE_SUPABASE_ANON_KEY is not set"
            echo "Required GitHub secret missing: WEBSITE_${{ github.event_name == 'pull_request' && 'PREVIEW' || 'PRODUCTION' }}_SUPABASE_ANON_KEY"
            exit 1
          fi
          if [[ ! "$VITE_SUPABASE_URL" =~ ^https:// ]]; then
            echo "❌ Error: VITE_SUPABASE_URL must use https:// (not http://)"
            echo "Current value: $VITE_SUPABASE_URL"
            exit 1
          fi
          echo "✅ Supabase environment variables are valid"

      - name: Deploy website
        id: deploy-website
        if: steps.check-affected.outputs.affected == 'true'
        env:
          CLOUDFLARE_BRANCH: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'main' }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            pnpm nx run website:deploy:preview --skip-nx-cache
          else
            pnpm nx run website:deploy --skip-nx-cache
          fi

      - name: Post deployment comment
        if: always()
        uses: ./.github/actions/deployment-comment
        with:
          project-name: Website
          preview-url: https://pr-${{ github.event.pull_request.number }}.pgflow.pages.dev
          production-url: https://pgflow.dev

# ────────────────────────────────── 4. DEPLOY DEMO ───────────────────────────
  deploy-demo:
    needs: [build-and-test, edge-worker-e2e]
    runs-on: ubuntu-latest
    # Only run on main branch pushes (production) - skip PRs for now
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      # Hardcoded for testing - these are public values
      VITE_SUPABASE_URL: https://bsgbmmbmlmcmdnheuwmt.supabase.co
      VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzZ2JtbWJtbG1jbWRuaGV1d210Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDA2NzIsImV4cCI6MjA3NzkxNjY3Mn0.Uoy8iqxycrqd4b6LPMMXWWSYrP1BDRMrJVgM2_vtl6o
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Set Nx SHAs for affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Verify NX_BASE and NX_HEAD are set
        run: echo "BASE=$NX_BASE HEAD=$NX_HEAD"

      - name: Check if demo is affected
        id: check-affected
        run: |
          if pnpm nx show projects --affected -t build --base="$NX_BASE" --head="$NX_HEAD" | grep -q "^demo$"; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Demo is affected by changes"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "Demo is not affected by changes - skipping deployment"
          fi

      - name: Validate Supabase environment variables
        if: steps.check-affected.outputs.affected == 'true'
        run: |
          if [ -z "$VITE_SUPABASE_URL" ]; then
            echo "❌ Error: VITE_SUPABASE_URL is not set"
            echo "Required GitHub secret missing: DEMO_${{ github.event_name == 'pull_request' && 'PREVIEW' || 'PRODUCTION' }}_SUPABASE_URL"
            exit 1
          fi
          if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "❌ Error: VITE_SUPABASE_ANON_KEY is not set"
            echo "Required GitHub secret missing: DEMO_${{ github.event_name == 'pull_request' && 'PREVIEW' || 'PRODUCTION' }}_SUPABASE_ANON_KEY"
            exit 1
          fi
          if [[ ! "$VITE_SUPABASE_URL" =~ ^https:// ]]; then
            echo "❌ Error: VITE_SUPABASE_URL must use https:// (not http://)"
            echo "Current value: $VITE_SUPABASE_URL"
            exit 1
          fi
          echo "✅ Supabase environment variables are valid"

      - name: Deploy demo to production
        id: deploy-demo
        if: steps.check-affected.outputs.affected == 'true'
        run: |
          echo "Deploying demo to production (demo.pgflow.dev)..."
          pnpm nx run demo:deploy --skip-nx-cache

      - name: Post deployment comment
        if: always()
        uses: ./.github/actions/deployment-comment
        with:
          project-name: Demo
          production-url: https://demo.pgflow.dev
          # No preview URL - we only deploy production from main branch

