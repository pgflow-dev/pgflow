name: CI
on:
  pull_request:
    branches: ['**', '!changeset-release/**']
  push:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  pull-requests: write       # for preview comments
  deployments: write         # Netlify action needs it

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  CLOUDFLARE_API_TOKEN:     ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID:    ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
# ─────────────────────────────────────── 1. BUILD ──────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    outputs:
      playground-built: ${{ steps.playground_build.outputs.built }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
        with: 
          version: '8.14.1'
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: '1.45.2'

      - name: Install sqruff
        uses: quarylabs/install-sqruff-cli-action@main

      - name: Setup Atlas
        uses: ariga/setup-atlas@master
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}


      - run: pnpm install --frozen-lockfile --prefer-offline

      - name: Set Nx SHAs for affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Quality gate (lint + typecheck + test)
        run: pnpm nx affected -t lint typecheck test --parallel --configuration=production

      - name: Build all affected projects (except playground)
        run: pnpm nx affected -t build --configuration=production --parallel --exclude=playground

      # ── playground build with env vars ────────────────────────────────────────
      - name: Build playground
        id: playground_build
        if: github.event_name == 'pull_request' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        run: |
          # Check if playground is affected
          if pnpm nx show projects --affected --plain | grep -qx "playground"; then
            echo "Playground is affected, building..."
            
            # Set environment variables based on event type
            export NEXT_PUBLIC_SUPABASE_URL=${{ github.event_name == 'pull_request' && secrets.DEMO_PREVIEW_SUPABASE_URL || secrets.DEMO_PRODUCTION_SUPABASE_URL }}
            export NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ github.event_name == 'pull_request' && secrets.DEMO_PREVIEW_SUPABASE_ANON_KEY || secrets.DEMO_PRODUCTION_SUPABASE_ANON_KEY }}
            
            # Build and set output based on success
            if pnpm nx run playground:build; then
              echo "Build successful"
              echo "built=true" >> $GITHUB_OUTPUT
              
            else
              echo "Build failed"
              echo "built=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "Playground not affected, skipping build"
            echo "built=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload playground artifact
        if: steps.playground_build.outputs.built == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playground-dist
          path: |
            examples/playground/.netlify/
            examples/playground/.next/
          include-hidden-files: true
          retention-days: 7
          if-no-files-found: error


# ────────────────────────────────── 2. PREVIEW DEPLOYS (PR) ───────────────────────────
  deploy-preview-playground:
    needs: build
    # Only run for PRs from the same repository (not forks) to ensure secrets are available
    if: |
      github.event_name == 'pull_request' && 
      needs.build.outputs.playground-built == 'true' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID:    ${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}
    steps:

      - uses: actions/download-artifact@v4
        with: 
          name: playground-dist

      - name: Debug artifact contents
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Top level contents ==="
          ls -la
          echo "=== Finding .netlify directories anywhere ==="
          find . -name ".netlify" -type d 2>/dev/null | head -20
          echo "=== Finding .next directories anywhere ==="
          find . -name ".next" -type d 2>/dev/null | head -20

      - name: Deploy to Netlify
        working-directory: ${{ github.workspace }}
        run: |
          # Verify the artifact extracted to the correct location
          echo "=== Verifying artifact extraction ==="
          ls examples/playground/.netlify/functions-internal/___netlify-server-handler || {
            echo "ERROR: Server handler not found at expected location!"
            echo "Looking for .netlify directories:"
            find . -name ".netlify" -type d
            exit 1
          }
          
          # Create state.json at repo root for monorepo detection
          mkdir -p .netlify
          echo "{\"siteId\":\"${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}\"}" > .netlify/state.json
          
          # Deploy
          npx netlify-cli@22.1.3 deploy \
            --filter=examples/playground \
            --dir=examples/playground/.next \
            --alias=pr-${{ github.event.pull_request.number }} \
            --message="PR #${{ github.event.pull_request.number }}" \
            --no-build
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}

  deploy-preview-website:
    needs: build
    # Only run for PRs from the same repository (not forks) to ensure secrets are available
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { version: '8.14.1' }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile --prefer-offline
      - run: pnpm nx run website:deploy:preview --skip-nx-cache

# ──────────────────────────────── 3. PRODUCTION DEPLOYS (main) ────────────────────────
  deploy-production-playground:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.build.outputs.playground-built == 'true'
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID:    ${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}
    steps:
      - uses: actions/download-artifact@v4
        with: 
          name: playground-dist

      - name: Deploy to Netlify Production
        working-directory: ${{ github.workspace }}
        run: |
          # Create state.json at repo root for monorepo detection
          mkdir -p .netlify
          echo "{\"siteId\":\"${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}\"}" > .netlify/state.json
          npx netlify-cli@22.1.3 deploy \
            --filter=examples/playground \
            --dir=examples/playground/.next \
            --prod \
            --message="Deploy from GitHub Actions (main)" \
            --no-build
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_PLAYGROUND_SITE_ID }}

  deploy-production-website:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { version: '8.14.1' }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile --prefer-offline
      - run: pnpm nx run website:deploy --skip-nx-cache